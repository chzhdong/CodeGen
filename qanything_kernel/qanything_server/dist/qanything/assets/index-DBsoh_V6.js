import{d as e,U as a,a as l,r as t,o as s,k as i,B as n,q as o,c,x as u,S as r,D as d,K as p,v,z as m,A as h,j as f,e as g,l as k,J as y,C as _,n as w,y as b,W as x,M as C,F as S,G as j,L as D,Z as T,E as L,Q as I,R as F}from"./index-BOQWRSv-.js";import{u as q,a as B,b as U,D as O,f as K,h as z,C as E,T as M,_ as R,c as N}from"./ChatInfoPanel-B2MnKrGD.js";import{_ as P}from"./scroll-down-Dm5D91pw.js";import{u as A,_ as H}from"./useChatSource-CVdT_vQJ.js";import{g as Q,u as $}from"./index-B-VGBmzJ.js";import{c as V,p as J,r as W,u as G,a as Z,b as X,C as Y,f as ee}from"./utils-DgQiGfGs.js";import{u as ae}from"./useQuickStart-DmSRwdo_.js";import{C as le}from"./ChatSettingDialog-B0MdGUH7.js";import{u as te,a as se,c as ie,p as ne,C as oe}from"./useUploadFiles-CJjF3D36.js";import{L as ce,_ as ue,F as re,O as de}from"./OptionList-BkiEKHvg.js";import{u as pe}from"./useChatSetting-C_Q_RWik.js";import{u as ve}from"./useBots-DbnaIHJs.js";import{_ as me}from"./ActionButton-kxRHFmPt.js";import{_ as he}from"./index-CMd10nF3.js";import"./index-C0drqHzp.js";import"./RightOutlined-k6Ldo487.js";import"./CheckOutlined-C0I0DHjL.js";import"./index-4PmJ48K0.js";import"./slide-a1Tp5F_n.js";import"./index-C23k2m5x.js";import"./index-8w8lTtg9.js";import"./index-Cfg1_ubR.js";import"./index-CyFJb4x8.js";import"./class-FJ4HjPo2.js";import"./index-C7EFTC32.js";import"./collapseMotion-CxcQHKaF.js";import"./injectionKey-BS_bSTfS.js";const fe={class:"contain"},ge={key:0,class:"loading"},ke={key:1,class:"progress"},ye={class:"file-name"},_e={key:0,class:"file-extension"},we={key:1,class:"file-extension"},be=h(e({__name:"FileBlock",props:{fileData:{},kbId:{},status:{}},emits:["deleteFile"],setup(e,{emit:h}){const{setChatSourceVisible:f,setSourceType:g,setSourceUrl:k,setTextContent:y}=A(),_=h,w=e,{fileData:b,kbId:x}=a(w),C=l((()=>"gray"===D.value)),S=l((()=>J(b.value.file_name))),j=l((()=>"red"===D.value?"file-error":"green"===D.value?"file-"+T.get(S.value.fileExtension):"file-unknown")),D=l((()=>b.value.status)),T=new Map([["md","txt"],["txt","txt"],["pdf","pdf"],["jpg","img"],["png","img"],["jpeg","img"],["docx","docx"],["xlsx","xlsx"],["pptx","ppt"],["eml","eml"],["csv","xlsx"]]),L=new Map([["gray","上传中"],["yellow","解析中"],["green","解析成功"],["red","解析失败"]]),I=t(0),F=async()=>{_("deleteFile",b.value.file_id,x.value)};s((()=>{(()=>{let e=t(null);e.value=setInterval((async()=>{var a,l,t;if(""===b.value.file_id&&"loading"!==b.value.status&&(b.value.status="red"),"green"===b.value.status||"red"===b.value.status)clearInterval(e.value),e.value=null;else{const e=await W(await G.fileList({kb_id:x.value,file_id:b.value.file_id}));b.value.status=(null==(a=e.details[0])?void 0:a.status)||"red","yellow"===(null==(l=e.details[0])?void 0:l.status)&&(I.value=parseInt(null==(t=e.details[0])?void 0:t.msg.match(/\d+/)[0],10))}}),1e3)})()}));const q=()=>{"yellow"===D.value||"green"===D.value?U(b.value):m.warn("解析中、解析完成才可以预览")};let B=["pdf","docx","xlsx","txt","md","jpg","png","jpeg"];const U=e=>{(e=>{if(!e)return!1;const a=e.split(".");if(a.length){const e=a.pop();return B.includes(e)}return!1})(e.file_name)&&async function(e){try{k(null);const a=await W(await G.getFile({file_id:e.file_id})),l=e.file_name.split(".").pop(),t=function(e){const a=B.indexOf(e);return O[a]}(l);if(g(l),k(`data:${t};base64,${a.file_base64}`),"txt"===l||"md"===l){const e=atob(a.file_base64),l=decodeURIComponent(escape(e));y(l),f(!0)}else f(!0)}catch(a){m.error(a.msg||"获取文件失败")}}(e)};let O=["application/pdf","application/vnd.openxmlformats-officedocument.wordprocessingml.document","application/vnd.openxmlformats-officedocument.spreadsheetml.sheet","text/plain","text/markdown","image/jpeg","image/png","image/jpeg"];return(e,a)=>{const l=ue;return i(),n("div",fe,[o("div",{class:"file-icon",onClick:q},[c(r,{name:u(j)},null,8,["name"]),o("div",{class:d(u(C)||"yellow"===u(D)?"mask":"")},null,2),u(C)?(i(),n("div",ge,[c(ce)])):p("",!0),"yellow"===u(D)?(i(),n("div",ke,[c(l,{type:"circle",percent:u(I),size:25},null,8,["percent"])])):p("",!0)]),o("div",{class:"file-info",onClick:q},[o("span",ye,v(u(S).fileName),1),"green"===u(D)?(i(),n("span",_e,v(u(S).fileExtension.toUpperCase())+", "+v(u(V)(u(b).bytes)||0),1)):(i(),n("span",we,v(u(L).get(u(D))),1))]),"toBeSend"===e.status?(i(),n("div",{key:0,class:"file-close",onClick:F},[c(r,{name:"close"})])):p("",!0)])}}}),[["__scopeId","data-v-9a48aea2"]]),xe=e=>(I("data-v-c59102c0"),e=e(),F(),e),Ce={class:"container"},Se={key:1,class:"my-page"},je={key:0,class:"user"},De=xe((()=>o("img",{class:"avatar",src:R,alt:"头像"},null,-1))),Te={class:"question-inner"},Le={class:"question-text"},Ie={key:0,class:"file-list-box"},Fe={key:1,class:"ai"},qe=xe((()=>o("img",{class:"avatar",src:N,alt:"头像"},null,-1))),Be={class:"ai-content"},Ue={class:"ai-right"},Oe={key:0},Ke={key:1},ze={class:"source-list"},Ee={class:"control"},Me={class:"tips"},Re=["href"],Ne=["onClick"],Pe={class:"source-content"},Ae={class:"score"},He={class:"tips"},Qe={key:1,class:"feed-back"},$e=["onClick"],Ve={class:"reload-text"},Je={class:"tools"},We={key:0,class:"stop-btn"},Ge={class:"question-box"},Ze={class:"question"},Xe={key:0,class:"file-list-box"},Ye={class:"send-box"},ea={class:"send-action"},aa=h(e({__name:"index",setup(e){const{common:a,home:h}=Q(),{copy:I}=q(),{QA_List:F,chatId:R,kbId:N,kbIdCopy:V,showLoading:J}=f(ae()),{addHistoryList:ce,updateHistoryList:ue,addChatList:fe,clearChatList:ge,getHistoryById:ke,renameHistory:ye,addFileToBeSendList:_e}=ae(),{setCopyUrlVisible:we,setWebUrl:xe}=ve(),{setChatSourceVisible:aa,setSourceType:la,setSourceUrl:ta,setTextContent:sa}=A(),{chatSettingFormActive:ia}=f(pe()),{showDefault:na}=f(te()),{setModalVisible:oa,setModalTitle:ca}=se(),{uploadFileListQuick:ua}=f(ie()),{initUploadFileListQuick:ra}=ie(),{language:da}=f($()),pa=l((()=>ke(R.value))),va=new M((e=>{e&&(F.value[F.value.length-1].answer+=e||"")})),ma=t(""),ha=l((()=>{const e=ia.value.context;if(0===e)return[];const a=F.value.filter((e=>"ai"===e.type));return(1===e?a:a.slice(-e)).map((e=>[e.question,e.answer]))})),fa=t([]);let ga;const ka=t(null),ya=t(null),_a=()=>{x((()=>{var e;null==(e=ya.value)||e.scrollIntoView({behavior:"smooth",block:"end"})}))},wa=l((()=>{var e;return((null==(e=pa.value)?void 0:e.fileToBeSendList.concat(null==ua?void 0:ua.value))||[]).filter((e=>0!==e.file_id.length))}));s((()=>{V.value&&(N.value=V.value),_a()})),g((()=>{ba()}));const ba=()=>{ua.value.length&&(_e(R.value,[...ua.value]),ra())};window.addEventListener("beforeunload",ba);const xa=e=>{13===e.keyCode&&(e.altKey||e.ctrlKey||e.shiftKey||e.metaKey?ma.value+="\n":La(),e.preventDefault())},Ca=B(((e,a)=>{if(e.like=!e.like,e.unlike=!1,_czc.push(["_trackEvent","qanything","问答页面","点赞","",""]),e.like){a.target.parentNode.style.animation="shake ease-in .5s";const e=setTimeout((()=>{clearTimeout(e),a.target.parentNode.style.animation=""}),600)}}),800),Sa=async(e,a)=>{try{await W(await G.deleteFile({file_ids:[e],kb_id:a})),m.success("删除成功");const l=ua.value.findIndex((a=>a.file_id===e));-1!==l?ua.value.splice(l,1):pa.value.fileToBeSendList=pa.value.fileToBeSendList.filter((a=>a.file_id!==e))}catch(l){m.error(l.msg||"删除失败")}},ja=e=>{F.value.push({answer:"",question:e,onlySearch:ia.value.capabilities.onlySearch,type:"ai",copied:!1,like:!1,unlike:!1,source:[],showTools:!1})},Da=new Y,Ta=()=>{ga&&ga.abort(),va.done(),J.value=!1,F.value[F.value.length-1].showTools=!0},La=async()=>{if(!ma.value.trim().length)return;if(J.value)return void m.warn("正在聊天中...请等待结束");if(!(await Ra()))return void m.error("模型设置错误，请先检查模型配置");const e=ma.value;await(async e=>{try{if(null!==R.value)return void("未命名对话"===ke(R.value).title&&ye(R.value,e));e.length>100&&(e=e.substring(0,100));const a=await W(await G.createKb({kb_name:e}));N.value=a.kb_id,R.value=ce(e),ue(e,R.value,N.value)}catch(a){m.error(a.msg||"创建对话失败")}})(e),ma.value="",(e=>{F.value.push({question:e,type:"user",fileDataList:[...wa.value.filter((e=>"red"!==e.status))]}),_a()})(e),fe(R.value,F.value),ra(),pa.value.fileToBeSendList=[],J.value=!0,ga=new AbortController;const l={kb_ids:[N.value],history:ha.value,question:e,streaming:!1===ia.value.capabilities.onlySearch,networking:ia.value.capabilities.networkSearch,product_source:"saas",rerank:ia.value.capabilities.rerank,only_need_search_results:ia.value.capabilities.onlySearch,hybrid_search:ia.value.capabilities.mixedSearch,max_token:ia.value.maxToken,api_base:ia.value.apiBase,api_key:ia.value.apiKey,model:ia.value.apiModelName,api_context_length:ia.value.apiContextLength,chunk_size:ia.value.chunkSize,top_p:ia.value.top_P,top_k:ia.value.top_K,temperature:ia.value.temperature};if(ia.value.capabilities.onlySearch){Da.addChatSetting(ia.value),ja(e);try{const e=await W(await G.sendQuestion(l));200===e.code&&(F.value[F.value.length-1].answer=(null==e?void 0:e.source_documents.length)?a.searchCompleted:a.searchNotFound,F.value[F.value.length-1].source=null==e?void 0:e.source_documents)}catch(t){m.error(t.msg||"出错了"),F.value[F.value.length-1].answer=t||"error"}J.value=!1,F.value[F.value.length-1].showTools=!0,fe(R.value,F.value),await x((()=>{_a()}))}else K(X+"/local_doc_qa/local_doc_chat",{method:"POST",headers:{"Content-Type":"application/json",Accept:["text/event-stream","application/json"]},openWhenHidden:!0,body:JSON.stringify({user_id:Z,...l}),signal:ga.signal,onopen(a){ja(e),a.ok&&"text/event-stream"===a.headers.get("content-type")?(Da.addChatSetting(ia.value),va.start()):"application/json"===a.headers.get("content-type")&&va.add("Error 请检查模型是否配置正确")},onmessage(e){var a,l;const t=JSON.parse(e.data);if(200==(null==t?void 0:t.code)&&(null==t?void 0:t.response)&&"success"===t.msg)va.add(null==t?void 0:t.response),_a();else{delete t.time_record.time_usage.retriever_search_by_milvus,Da.addTime(t.time_record.time_usage),Da.addToken(t.time_record.token_usage),Da.addDate(Date.now())}(null==(a=null==t?void 0:t.source_documents)?void 0:a.length)&&(F.value[F.value.length-1].source=null==t?void 0:t.source_documents),(null==(l=null==t?void 0:t.show_images)?void 0:l.length)&&(null==t||t.show_images.map((e=>{va.add(e)})))},onclose(e){va.done(),ga.abort(),J.value=!1,F.value[F.value.length-1].showTools=!0,F.value.at(-1).itemInfo=Da.getChatInfo(),fe(R.value,F.value),x((()=>{_a()}))},onerror(e){throw null==va||va.done(),null==ga||ga.abort(),J.value=!1,F.value[F.value.length-1].showTools=!0,m.error(e.msg||"出错了"),fe(R.value,F.value),x((()=>{_a()})),e}})},Ia=async()=>{if(null!==R.value)try{const{bot_id:e}=await W(await G.createBot({bot_name:"bot-"+ee(Date.now()),description:"来源: 快速开始创建-"+ee(Date.now())}));await W(await G.updateBot({bot_id:e,kb_ids:[N.value],only_need_search_results:ia.value.capabilities.onlySearch,networking:ia.value.capabilities.networkSearch,api_base:ia.value.apiBase,api_key:ia.value.apiKey,api_context_length:ia.value.apiContextLength,top_p:ia.value.top_P,temperature:ia.value.temperature,top_k:ia.value.top_K,model:ia.value.apiModelName,max_token:ia.value.maxToken,hybrid_search:ia.value.capabilities.mixedSearch,chunk_size:ia.value.chunkSize,rerank:ia.value.capabilities.rerank})),we(!0);const{origin:a,pathname:l}=window.location;xe(`${a+l}#/bots/${e}/share`)}catch(e){m.error((null==e?void 0:e.msg)||"分享失败")}},{showModal:Fa}=f(U()),qa=t(!1),Ba=t(""),Ua=t(""),Oa=()=>{J.value||N.value&&(oa(!0),ca(h.upload))},Ka=()=>{J.value||(Ua.value="download",Fa.value=!0,Ba.value=a.saveTip)},za=async()=>{if(qa.value=!0,"download"===Ua.value)try{const e=document.getElementById("chat-ul"),a=(await z(e,{useCORS:!0})).toDataURL("image/png"),l=document.createElement("a");l.style.display="none",l.href=a,l.setAttribute("download","chat-shot.png"),void 0===l.download&&l.setAttribute("target","_blank"),document.body.appendChild(l),l.click(),document.body.removeChild(l),window.URL.revokeObjectURL(a),m.success("下载成功"),await Promise.resolve()}catch(e){m.error(e.message||e.msg||"出错了")}else"delete"===Ua.value&&(ge(R.value),R.value=null,F.value=[]);Ua.value="",Ba.value="",qa.value=!1,Fa.value=!1},{showSettingModal:Ea}=f(U()),Ma=t(),Ra=()=>Ma.value.handleOk();let Na=["pdf","docx","xlsx","txt","md","jpg","png","jpeg","csv","eml"];const Pa=e=>{if(!e)return!1;const a=e.split(".");if(a.length){const e=a.pop();return Na.includes(e)}return!1},Aa=e=>{Pa(e.file_name)&&async function(e){try{ta(null);const a=await W(await G.getFile({file_id:e.file_id})),l=e.file_name.split(".").pop(),t=function(e){const a=Na.indexOf(e);return Ha[a]}(l);if(la(l),ta(`data:${t};base64,${a.file_base64}`),"txt"===l||"md"===l||"csv"===l||"eml"===l){const e=atob(a.file_base64),l=decodeURIComponent(escape(e));sa(l),aa(!0)}else aa(!0)}catch(a){m.error(a.msg||"获取文件失败")}}(e)};let Ha=["application/pdf","application/vnd.openxmlformats-officedocument.wordprocessingml.document","application/vnd.openxmlformats-officedocument.spreadsheetml.sheet","text/plain","text/markdown","image/jpeg","image/png","image/jpeg","text/csv","message/rfc822","application/vnd.openxmlformats-officedocument.presentationml.presentation"];g((()=>{Qa()}));const Qa=()=>{V.value=N.value,N.value=""};return window.addEventListener("onbeforeunload",Qa),(e,l)=>{const t=C,s=me,h=he;return i(),n(y,null,[o("div",Ce,[u(na)===u(ne).optionlist?(i(),k(de,{key:0})):(i(),n("div",Se,[o("div",{id:"chat",ref_key:"chatContainer",ref:ka,class:"chat"},[o("ul",{id:"chat-ul",ref_key:"scrollDom",ref:ya},[(i(!0),n(y,null,_(u(F),((e,l)=>{var t,s;return i(),n("li",{key:l},["user"===e.type?(i(),n("div",je,[De,o("div",Te,[o("p",Le,v(e.question),1),e.fileDataList.length?(i(),n("div",Ie,[(i(!0),n(y,null,_(e.fileDataList,(e=>(i(),k(be,{key:e.file.lastModified,"file-data":e,"kb-id":u(N),"chat-id":u(R),status:"send"},null,8,["file-data","kb-id","chat-id"])))),128))])):p("",!0)])])):(i(),n("div",Fe,[qe,o("div",Be,[o("div",Ue,[o("p",{class:d(["question-text",[e.source.length||(null==(t=null==e?void 0:e.picList)?void 0:t.length)?"":"change-radius",e.showTools?"":"flashing"]])},[c(H,{content:e.answer},null,8,["content"]),Object.keys((null==(s=null==e?void 0:e.itemInfo)?void 0:s.tokenInfo)||{}).length?(i(),k(E,{key:0,"chat-item-info":e.itemInfo},null,8,["chat-item-info"])):p("",!0)],2),e.source.length?(i(),n(y,{key:0},[o("div",{class:d(["source-total",u(fa).includes(l)?"":"source-total-last"])},["zh"===u(da)?(i(),n("span",Oe," 找到了"+v(e.source.length)+"个信息来源： ",1)):(i(),n("span",Ke," Found "+v(e.source.length)+" source of information ",1)),S(c(r,{name:"down",onClick:e=>(e=>{fa.value.push(e)})(l)},null,8,["onClick"]),[[j,!u(fa).includes(l)]]),S(c(r,{name:"up",onClick:e=>(e=>{fa.value=fa.value.filter((a=>a!==e))})(l)},null,8,["onClick"]),[[j,u(fa).includes(l)]])],2),S(o("div",ze,[(i(!0),n(y,null,_(e.source,((l,t)=>(i(),n("div",{key:t,class:"data-source"},[S(o("p",Ee,[o("span",Me,v(u(a).dataSource)+v(t+1)+":",1),l.file_url.startsWith("http")?(i(),n("a",{key:0,href:l.file_url,target:"_blank"},v(l.file_name),9,Re)):(i(),n("span",{key:1,class:d(["file",Pa(l.file_name)?"filename-active":""]),onClick:e=>Aa(l)},v(l.file_name),11,Ne)),S(c(r,{name:"iconup",onClick:a=>((e,a)=>{e.source[a].showDetailDataSource=!1})(e,t)},null,8,["onClick"]),[[j,l.showDetailDataSource]]),S(c(r,{name:"icondown",onClick:a=>((e,a)=>{e.source[a].showDetailDataSource=!e.source[a].showDetailDataSource})(e,t)},null,8,["onClick"]),[[j,!l.showDetailDataSource]])],512),[[j,l.file_name]]),c(T,{name:"sourceItem"},{default:w((()=>[S(o("div",Pe,[c(H,{content:l.content},null,8,["content"]),o("p",Ae,[o("span",He,v(u(a).correlation),1),D(" "+v(l.score),1)])],512),[[j,l.showDetailDataSource]])])),_:2},1024)])))),128))],512),[[j,u(fa).includes(l)]])],64)):p("",!0),e.showTools?(i(),n("div",Qe,[o("div",{class:"reload-box",onClick:a=>(e=>{ma.value=e.question,La()})(e)},[c(r,{name:"reload"}),o("span",Ve,v(u(a).regenerate),1)],8,$e),o("div",Je,[c(r,{style:L({color:e.copied?"#4D71FF":""}),name:"copy",onClick:l=>(e=>{I(e.answer).then((()=>{e.copied=!e.copied,m.success(a.copySuccess,1);const l=setTimeout((()=>{clearTimeout(l),e.copied=!e.copied}),1e3)})).catch((()=>{m.error(a.copyFailed,1)}))})(e)},null,8,["style","onClick"]),c(r,{style:L({color:e.like?"#4D71FF":""}),name:"like",onClick:a=>u(Ca)(e,a)},null,8,["style","onClick"]),c(r,{style:L({color:e.unlike?"#4D71FF":""}),name:"unlike",onClick:a=>(e=>{e.unlike=!e.unlike,e.like=!1,_czc.push(["_trackEvent","qanything","问答页面","点踩","",""])})(e)},null,8,["style","onClick"])])])):p("",!0)])])]))])})),128))],512)],512),u(J)?(i(),n("div",We,[c(t,{onClick:Ta},{icon:w((()=>[c(r,{name:"stop",class:d(u(J)?"loading":"")},null,8,["class"])])),default:w((()=>[D(" "+v(u(a).stop),1)])),_:1})])):p("",!0),o("div",Ge,[o("div",Ze,[u(wa).length?(i(),n("div",Xe,[(i(!0),n(y,null,_(u(wa),(e=>(i(),k(be,{key:e.file_id,"file-data":e,"kb-id":u(N),"chat-id":u(R),status:"toBeSend",onDeleteFile:Sa},null,8,["file-data","kb-id","chat-id"])))),128))])):p("",!0),o("div",Ye,[c(s,{value:u(ma),"onUpdate:value":l[0]||(l[0]=e=>b(ma)?ma.value=e:null),class:"send-textarea","max-length":"200",bordered:!1,placeholder:u(a).problemPlaceholder,"auto-size":{minRows:1,maxRows:8},onKeydown:xa},null,8,["value","placeholder"]),o("div",ea,[c(h,null,{content:w((()=>[D(v(u(R)?u(a).chatShare:u(a).chatShareNoChatId),1)])),default:w((()=>[o("span",{class:d(["question-icon",u(J)||!u(R)?"isPreventClick":""]),onClick:Ia},[c(r,{name:"chat-share"})],2)])),_:1}),c(h,null,{content:w((()=>[D(v(u(N)?u(a).chatUpload:u(a).chatUploadNoKbId),1)])),default:w((()=>[o("span",{class:d(["question-icon",u(J)||!u(N)?"isPreventClick":""]),onClick:Oa},[c(r,{name:"chat-upload"})],2)])),_:1}),c(h,null,{content:w((()=>[D(v(u(a).chatToPic),1)])),default:w((()=>[o("span",{class:d(["question-icon",u(J)?"isPreventClick":""]),onClick:Ka},[c(r,{name:"chat-download"})],2)])),_:1}),c(h,null,{content:w((()=>[D(v(u(a).modelSettingTitle),1)])),default:w((()=>[o("span",{class:"question-icon",onClick:l[1]||(l[1]=e=>{return a=!0,void(Ea.value=a);var a})},[c(r,{name:"chat-setting"})])])),_:1}),c(t,{type:"primary",disabled:u(J),shape:"circle",onClick:La},{default:w((()=>[c(r,{name:"sendplane"})])),_:1},8,["disabled"])])])])]),c(re,{"dialog-type":1})])),o("div",{class:"scroll-btn-div"},[o("img",{class:"avatar",src:P,alt:"滑到底部",onClick:_a})])]),c(le,{ref_key:"chatSettingForDialogRef",ref:Ma},null,512),c(O,{content:u(Ba),"confirm-loading":u(qa),onOk:za},null,8,["content","confirm-loading"]),c(oe)],64)}}}),[["__scopeId","data-v-c59102c0"]]);export{aa as default};
